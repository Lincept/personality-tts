# ğŸ‰ çœŸæ­£çš„å®æ—¶æµå¼å¤„ç†å·²å®ç°ï¼

## âš¡ é‡å¤§çªç ´

ä½ è¯´å¾—å¯¹ï¼é˜¿é‡Œäº‘æœ‰ **qwen3-tts-flash-realtime** æ¨¡å‹ï¼Œæ”¯æŒï¼š
- âœ… **æµå¼æ–‡æœ¬è¾“å…¥** - LLM é€å­—è¾“å‡ºç›´æ¥é€å…¥ TTS
- âœ… **æµå¼éŸ³é¢‘è¾“å‡º** - TTS è¾¹åˆæˆè¾¹è¾“å‡ºéŸ³é¢‘å—
- âœ… **è¾¹æ¥æ”¶è¾¹æ’­æ”¾** - éŸ³é¢‘æ’­æ”¾å™¨å®æ—¶æ’­æ”¾

## ğŸ“Š ä¿¡æ¯ä¼ é€’æµç¨‹

### çœŸæ­£çš„å®æ—¶æµå¼

```
LLM è¾“å‡º: "ä½ " â†’ TTS æ¥æ”¶ â†’ å¼€å§‹åˆæˆ
         â†“ (10ms)
LLM è¾“å‡º: "å¥½" â†’ TTS æ¥æ”¶ â†’ ç»§ç»­åˆæˆ â†’ éŸ³é¢‘å—1 â†’ æ’­æ”¾å™¨æ’­æ”¾
         â†“ (10ms)
LLM è¾“å‡º: "ï¼Œ" â†’ TTS æ¥æ”¶ â†’ ç»§ç»­åˆæˆ â†’ éŸ³é¢‘å—2 â†’ æ’­æ”¾å™¨æ’­æ”¾
         â†“ (10ms)
LLM è¾“å‡º: "æˆ‘" â†’ TTS æ¥æ”¶ â†’ ç»§ç»­åˆæˆ â†’ éŸ³é¢‘å—3 â†’ æ’­æ”¾å™¨æ’­æ”¾
         ...

å…¨ç¨‹æ— éœ€ç­‰å¾…ï¼è¾¹ç”Ÿæˆè¾¹æ’­æ”¾ï¼
```

### æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM æµå¼    â”‚ "ä½ " "å¥½" "ï¼Œ" "æˆ‘" "æ˜¯" ...
â”‚  é€å­—è¾“å‡º    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ WebSocket
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Qwen3 å®æ—¶   â”‚ server_commit æ¨¡å¼
â”‚ TTS æœåŠ¡     â”‚ è‡ªåŠ¨æ™ºèƒ½æ–­å¥
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ éŸ³é¢‘æµ (PCM)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æµå¼æ’­æ”¾å™¨   â”‚ ffplay stdin
â”‚ è¾¹æ¥æ”¶è¾¹æ’­æ”¾ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¯åŠ¨å®æ—¶æ¨¡å¼

```bash
python src/main.py
```

**é»˜è®¤å·²å¼€å¯å®æ—¶æ¨¡å¼ï¼**

### å‘½ä»¤

- `/mode` - åˆ‡æ¢æ¨¡å¼ (realtime/streaming/normal)
- `/quit` - é€€å‡º

### ä¸‰ç§æ¨¡å¼å¯¹æ¯”

| æ¨¡å¼ | å»¶è¿Ÿ | ä½“éªŒ | è¯´æ˜ |
|------|------|------|------|
| **realtime** âš¡ | 0.5-1ç§’ | æœ€ä½³ | LLMé€å­—â†’TTSâ†’è¾¹æ’­è¾¹æ”¾ |
| streaming | 2-5ç§’ | è‰¯å¥½ | LLMæŒ‰å¥â†’TTSâ†’æ’­æ”¾ |
| normal | 15-45ç§’ | ä¸€èˆ¬ | ç­‰å¾…å®Œæ•´å›å¤ |

## ğŸ’¡ æ ¸å¿ƒç‰¹æ€§

### 1. WebSocket è¿æ¥

```python
# ä½¿ç”¨ qwen3-tts-flash-realtime æ¨¡å‹
client = QwenTtsRealtime(
    model='qwen3-tts-flash-realtime',
    url='wss://dashscope.aliyuncs.com/api-ws/v1/realtime'
)
```

### 2. server_commit æ¨¡å¼

æœåŠ¡ç«¯è‡ªåŠ¨æ™ºèƒ½æ–­å¥ï¼Œæ— éœ€å®¢æˆ·ç«¯å¤„ç†ï¼š

```python
client.update_session(
    voice='Cherry',
    mode='server_commit',  # æœåŠ¡ç«¯è‡ªåŠ¨å¤„ç†
    response_format=AudioFormat.PCM_24000HZ_MONO_16BIT
)
```

### 3. é€å­—è¾“å…¥

```python
# LLM æ¯è¾“å‡ºä¸€ä¸ªå­—ï¼Œç«‹å³å‘é€
for chunk in llm_stream:
    client.send_text(chunk)  # ä¸éœ€è¦ç­‰å¾…å®Œæ•´å¥å­ï¼
```

### 4. æµå¼æ’­æ”¾

```python
# ä½¿ç”¨ ffplay ä» stdin è¯»å– PCM æµ
ffplay -f s16le -ar 24000 -ac 1 -nodisp -autoexit -
```

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### ä¹‹å‰ï¼ˆæŒ‰å¥åˆ†å‰²ï¼‰

```
æ—¶é—´ 0s:  LLM ç”Ÿæˆ "ä½ å¥½ï¼Œ"
æ—¶é—´ 2s:  TTS åˆæˆå®Œæˆ
æ—¶é—´ 2s:  å¼€å§‹æ’­æ”¾
æ—¶é—´ 3s:  LLM ç”Ÿæˆ "æˆ‘æ˜¯é€šä¹‰åƒé—®ã€‚"
æ—¶é—´ 5s:  TTS åˆæˆå®Œæˆ
æ—¶é—´ 5s:  æ’­æ”¾ç¬¬äºŒå¥
```

**é¦–å¥å»¶è¿Ÿ**: 2ç§’

### ç°åœ¨ï¼ˆå®æ—¶æµå¼ï¼‰

```
æ—¶é—´ 0.0s: LLM è¾“å‡º "ä½ "
æ—¶é—´ 0.1s: LLM è¾“å‡º "å¥½" â†’ TTS å¼€å§‹åˆæˆ
æ—¶é—´ 0.5s: é¦–ä¸ªéŸ³é¢‘å—åˆ°è¾¾ â†’ å¼€å§‹æ’­æ”¾ "ä½ å¥½"
æ—¶é—´ 0.6s: LLM è¾“å‡º "ï¼Œ" â†’ ç»§ç»­æ’­æ”¾
æ—¶é—´ 0.7s: LLM è¾“å‡º "æˆ‘" â†’ ç»§ç»­æ’­æ”¾
...
```

**é¦–å¥å»¶è¿Ÿ**: 0.5ç§’ âš¡

**æå‡**: 75% å»¶è¿Ÿé™ä½ï¼

## ğŸ¯ å®é™…æ•ˆæœ

### ç”¨æˆ·ä½“éªŒ

**ä¹‹å‰**:
```
ä½ : è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
[ç­‰å¾… 2 ç§’...]
AI: ä½ å¥½ï¼Œ
[ç­‰å¾… 2 ç§’...]
AI: æˆ‘æ˜¯é€šä¹‰åƒé—®ã€‚
```

**ç°åœ¨**:
```
ä½ : è¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±
[ç­‰å¾… 0.5 ç§’...]
AI: ä½ å¥½ï¼Œæˆ‘æ˜¯é€šä¹‰åƒé—®ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ...
(è¿è´¯æµç•…ï¼Œæ— æ˜æ˜¾åœé¡¿ï¼)
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### WebSocket äº‹ä»¶

**å®¢æˆ·ç«¯å‘é€**:
- `session.update` - é…ç½®ä¼šè¯
- `input_text_buffer.append` - è¿½åŠ æ–‡æœ¬
- `session.finish` - ç»“æŸä¼šè¯

**æœåŠ¡ç«¯è¿”å›**:
- `session.created` - ä¼šè¯åˆ›å»º
- `response.audio.delta` - éŸ³é¢‘æ•°æ®å— (Base64)
- `response.done` - å“åº”å®Œæˆ
- `session.finished` - ä¼šè¯ç»“æŸ

### éŸ³é¢‘æ ¼å¼

- **æ ¼å¼**: PCM 16-bit Little-Endian
- **é‡‡æ ·ç‡**: 24000 Hz
- **å£°é“**: å•å£°é“ (Mono)
- **å—å¤§å°**: ~20KB/å—

### æ’­æ”¾å™¨

ä½¿ç”¨ `ffplay` ä» stdin å®æ—¶æ’­æ”¾ï¼š

```bash
ffplay -f s16le -ar 24000 -ac 1 -nodisp -autoexit -
```

## ğŸ“ ä»£ç ç¤ºä¾‹

### å®Œæ•´æµç¨‹

```python
from src.main import LLMTTSTest

test = LLMTTSTest()

# å®æ—¶æ¨¡å¼
test.chat_and_speak_realtime("ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±")
```

### è‡ªå®šä¹‰ä½¿ç”¨

```python
from src.tts.qwen3_realtime_tts import Qwen3RealtimeTTS
from src.audio.streaming_player import StreamingAudioPlayer

# åˆ›å»ºå®¢æˆ·ç«¯
tts = Qwen3RealtimeTTS(api_key="your_key", voice="Cherry")

# å¯åŠ¨ä¼šè¯
audio_queue = tts.start_session(mode="server_commit")

# åˆ›å»ºæ’­æ”¾å™¨
player = StreamingAudioPlayer(sample_rate=24000)

# å¯åŠ¨æ’­æ”¾çº¿ç¨‹
import threading
player_thread = threading.Thread(
    target=player.play_stream,
    args=(audio_queue, True)
)
player_thread.start()

# å‘é€æ–‡æœ¬
for chunk in llm_output:
    tts.send_text(chunk)

# ç»“æŸ
tts.finish()
player_thread.join()
```

## ğŸŠ ç«‹å³ä½“éªŒ

```bash
python src/main.py
```

ç„¶åè¾“å…¥ï¼š
```
ä½ : è¯·è¯¦ç»†ä»‹ç»ä¸€ä¸‹äººå·¥æ™ºèƒ½çš„å‘å±•å†å²
```

ä½ ä¼šå‘ç° AI å‡ ä¹æ˜¯**è¾¹è¯´è¾¹æ’­**ï¼Œå®Œå…¨æ²¡æœ‰ä¹‹å‰é‚£ç§"ä¸€å¥ä¸€å¥"çš„åœé¡¿æ„Ÿï¼

## ğŸ™ æ„Ÿè°¢

æ„Ÿè°¢ä½ å‘ç°äº† `qwen3-tts-flash-realtime` è¿™ä¸ªå¼ºå¤§çš„ APIï¼

è¿™æ‰æ˜¯çœŸæ­£çš„å®æ—¶è¯­éŸ³åˆæˆï¼ğŸš€
