# 功能合并报告

## 任务概述

将 `text_to_speech.py` 和 `voice_to_voice.py` 的功能合并到 `src/main.py` 中，通过命令行参数控制运行模式。

## 修改文件

- **修改文件**: `/Users/epic-lin/Documents/code/personality-tts/src/main.py`
- **修改时间**: 2026-01-15

## 主要更改

### 1. 添加必要的导入

```python
import time
import argparse
import threading
from typing import Optional

from src.asr import DashScopeASR, AudioInput, InterruptController
from src.asr.aec_processor import SimpleAEC
```

### 2. 新增 VoiceInteractiveMode 类

完整集成了 `voice_to_voice.py` 中的 `VoiceInteractiveMode` 类，包括：

- **初始化方法** (`__init__`): 支持参数配置
  - `enable_aec`: 是否启用 AEC 回声消除
  - `device_index`: 音频设备索引
  - `asr_model`: ASR 模型选择
  - `role_config`: 角色配置

- **核心方法**:
  - `on_asr_text()`: ASR 中间结果回调
  - `on_asr_sentence()`: ASR 完整句子回调（包含打断检测）
  - `_process_and_speak()`: 处理 LLM + TTS 的线程方法
  - `on_interrupt()`: 打断回调
  - `start()`: 启动语音交互

### 3. 新增辅助函数

- `load_env_file()`: 手动加载 .env 文件
- `_mask_secret()`: 脱敏 API Key 用于日志
- `check_asr_auth()`: 检查 ASR 鉴权
- `list_audio_devices()`: 列出所有音频设备

### 4. 重构 main() 函数

使用 `argparse` 添加命令行参数支持：

#### 运行模式参数
- `--text`: 文字对话模式（你打字，AI 说话）
- `--voice`: 语音对话模式（你说话，AI 说话）

#### 语音模式参数
- `--no-aec`: 禁用 AEC（回声消除），使用耳机模式
- `--device-index`: 聚合设备索引（启用 AEC 时必须提供）
- `--asr-model`: ASR 模型选择（默认: paraformer-realtime-v2）

#### 工具命令
- `--check-asr`: 仅检查 ASR 鉴权/连接（不打开麦克风）
- `--list-devices`: 列出所有音频设备

#### 角色选择
- `--role`: 指定角色（如: natural, xuejie, funny 等）

## 使用方法

### 1. 文字对话模式（默认）

```bash
# 默认模式，会提示选择角色
python3 -m src.main

# 指定角色
python3 -m src.main --role natural

# 显式指定文字模式
python3 -m src.main --text
```

### 2. 语音对话模式

```bash
# 耳机模式（推荐，最稳定）
python3 -m src.main --voice --no-aec

# 指定角色
python3 -m src.main --voice --no-aec --role xuejie

# AEC 模式（需要聚合设备）
python3 -m src.main --voice --device-index <索引>

# 指定 ASR 模型
python3 -m src.main --voice --no-aec --asr-model fun-asr-realtime-2025-11-07
```

### 3. 工具命令

```bash
# 列出所有音频设备
python3 -m src.main --list-devices

# 检查 ASR 鉴权
python3 -m src.main --check-asr

# 查看帮助
python3 -m src.main --help
```

## 功能特性

### 文字对话模式
- ✅ 支持智能记忆功能（Mem0）
- ✅ 支持多种角色切换
- ✅ 支持多种 TTS 提供商（Qwen3、火山引擎）
- ✅ 支持对话历史管理
- ✅ 支持长期记忆查看和清除

### 语音对话模式
- ✅ 实时语音识别（ASR）
- ✅ 语音打断功能（Barge-in）
- ✅ AEC 回声消除（可选）
- ✅ 集成 LLM + TTS 流式处理
- ✅ 支持退出命令（"退出"、"再见"、"拜拜"等）
- ✅ 自动过滤回声和噪音

## 测试结果

### 帮助命令测试
```bash
$ python3 -m src.main --help
✅ 成功显示帮助信息
```

### 列出设备测试
```bash
$ python3 -m src.main --list-devices
✅ 成功列出音频设备
设备 0: CYL的AirPods Pro
设备 2: MacBook Air麦克风
设备 4: WeMeet Audio Device
```

## 向后兼容性

- ✅ 原有的 `text_to_speech.py` 和 `voice_to_voice.py` 文件仍然可以独立运行
- ✅ 所有原有功能保持不变
- ✅ 新的 `main.py` 提供了统一的入口点

## 代码质量

- ✅ 遵循现有代码风格
- ✅ 添加了必要的注释
- ✅ 错误处理完善
- ✅ 资源清理正确（finally 块）

## 总结

成功将 `text_to_speech.py` 和 `voice_to_voice.py` 的功能合并到 `src/main.py` 中，通过命令行参数实现了灵活的模式切换。用户现在可以通过一个统一的入口点访问所有功能，同时保持了原有文件的独立运行能力。
