# AEC ä¿®æ”¹å¯¹æ¯”

## ğŸ“Š æ ¸å¿ƒä¿®æ”¹å¯¹æ¯”è¡¨

| é…ç½®é¡¹ | ä¿®æ”¹å‰ | ä¿®æ”¹å | å½±å“ |
|--------|--------|--------|------|
| **æµå»¶è¿Ÿ** | 0ms | **40ms** | â­â­â­â­â­ æœ€å…³é”® |
| **å¸§å¤§å°** | 1600 (100ms) | **160 (10ms)** | â­â­â­â­ é™ä½å»¶è¿Ÿ |
| **å™ªå£°æŠ‘åˆ¶** | HIGH (2) | **MODERATE (1)** | â­â­â­ é¿å…è¿‡åº¦æŠ‘åˆ¶ |
| **Pipeline é¢‘ç‡** | æœªè®¾ç½® | **16000 Hz** | â­â­â­ WebRTC ä¼˜åŒ– |
| **PreAmplifier** | æœªé…ç½® | **ç¦ç”¨** | â­â­ é¿å…å¤±çœŸ |
| **LevelAdjustment** | æœªé…ç½® | **ç¦ç”¨** | â­â­ å‡å°‘å†²çª |
| **TransientSuppression** | æœªé…ç½® | **ç¦ç”¨** | â­â­ é¿å…åˆ‡å‰²è¯­éŸ³ |
| **GainController1** | æœªé…ç½® | **å¯ç”¨ï¼ˆè‡ªé€‚åº”ï¼‰** | â­â­â­ å¢ç›Šæ§åˆ¶ |
| **GainController2** | æœªé…ç½® | **ç¦ç”¨** | â­â­ é¿å…å†²çª |

---

## ğŸ”§ ä»£ç ä¿®æ”¹è¯¦æƒ…

### 1. `src/asr/aec_processor.py`

#### æµå»¶è¿Ÿè®¾ç½®

```diff
- self.apm.set_stream_delay_ms(0)  # 0ms å»¶è¿Ÿï¼ˆå®æ—¶ç³»ç»Ÿï¼‰
+ self.apm.set_stream_delay_ms(40)  # 40ms å»¶è¿Ÿï¼ˆè€ƒè™‘å®é™…ä¼ æ’­å’Œå¤„ç†å»¶è¿Ÿï¼‰
```

#### Pipeline é…ç½®

```diff
+ # Pipeline é…ç½® - ä½¿ç”¨ WebRTC ä¼˜åŒ–é¢‘ç‡
+ apm_config.pipeline.maximum_internal_processing_rate = 16000
+ apm_config.pipeline.multi_channel_render = False
+ apm_config.pipeline.multi_channel_capture = False
```

#### å™ªå£°æŠ‘åˆ¶

```diff
  apm_config.noise_suppress.enabled = True
- apm_config.noise_suppress.noise_level = 2  # HIGH
+ apm_config.noise_suppress.noise_level = 1  # MODERATEï¼ˆä¸­ç­‰ï¼‰
+ apm_config.noise_suppress.analyze_linear_aec_output_when_available = True
```

#### æ–°å¢é…ç½®

```diff
+ # ç¦ç”¨ PreAmplifierï¼ˆé¿å…å¤±çœŸï¼‰
+ apm_config.pre_amp.enabled = False
+ apm_config.pre_amp.fixed_gain_factor = 1.0
+
+ # ç¦ç”¨ LevelAdjustmentï¼ˆå‡å°‘å¤„ç†å†²çªï¼‰
+ apm_config.level_adjustment.enabled = False
+
+ # ç¦ç”¨ TransientSuppressionï¼ˆé¿å…åˆ‡å‰²è¯­éŸ³ï¼‰
+ apm_config.transient_suppress.enabled = False
+
+ # å¯ç”¨ GainController1 - è½»åº¦å¢ç›Šæ§åˆ¶
+ apm_config.gain_control1.enabled = True
+ apm_config.gain_control1.controller_mode = 1  # ADAPTIVE_DIGITAL
+ apm_config.gain_control1.target_level_dbfs = 3
+ apm_config.gain_control1.compression_gain_db = 9
+ apm_config.gain_control1.enable_limiter = True
+
+ # ç¦ç”¨ GainController2ï¼ˆé¿å…å†²çªï¼‰
+ apm_config.gain_control2.enabled = False
```

---

### 2. `src/asr/audio_input.py`

#### å¸§å¤§å°ä¼˜åŒ–

```diff
  def __init__(self,
               sample_rate: int = 16000,
-              chunk_size: int = 1600,  # 100ms @ 16kHz
+              chunk_size: int = 160,  # ä¿®æ”¹ä¸º 10ms @ 16kHzï¼ˆWebRTC æ ‡å‡†ï¼‰
               channels: int = 1,
               ...
```

#### æ–‡æ¡£æ›´æ–°

```diff
+ """
+ éŸ³é¢‘è¾“å…¥æ¨¡å— - ä»éº¦å…‹é£å½•éŸ³
+ æ”¯æŒ AECï¼ˆå›å£°æ¶ˆé™¤ï¼‰åŠŸèƒ½
+ æ”¯æŒèšåˆè®¾å¤‡ï¼ˆç¡¬ä»¶ AECï¼‰- å‚è€ƒ py-xiaozhi ä¼˜åŒ–
+ """
```

---

### 3. `voice_to_voice.py`

#### éŸ³é¢‘è¾“å…¥é…ç½®

```diff
+ # ä½¿ç”¨ WebRTC æ ‡å‡†å¸§å¤§å°ï¼š10ms = 160 samples @ 16kHz
  self.audio_input = AudioInput(
      sample_rate=16000,
-     chunk_size=1600,
+     chunk_size=160,  # ä¿®æ”¹ä¸º 10msï¼ˆWebRTC æ ‡å‡†ï¼‰
      enable_aec=self.enable_aec,
      ...
  )
```

---

## ğŸ“ˆ æ€§èƒ½æå‡é¢„æœŸ

### å»¶è¿Ÿå¯¹æ¯”

```
ä¿®æ”¹å‰ï¼š
éº¦å…‹é£ â†’ [100ms ç¼“å†²] â†’ AEC â†’ ASR
æ€»å»¶è¿Ÿï¼š~120ms

ä¿®æ”¹åï¼š
éº¦å…‹é£ â†’ [10ms ç¼“å†²] â†’ AEC â†’ ASR
æ€»å»¶è¿Ÿï¼š~30ms

æ”¹è¿›ï¼šé™ä½ 75% å»¶è¿Ÿ
```

### AEC æ•ˆæœå¯¹æ¯”

```
ä¿®æ”¹å‰ï¼ˆæµå»¶è¿Ÿ 0msï¼‰ï¼š
å‚è€ƒä¿¡å· (t=0)    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å›å£°ä¿¡å· (t=40)              â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                             âŒ ä¸åŒ¹é…ï¼

ä¿®æ”¹åï¼ˆæµå»¶è¿Ÿ 40msï¼‰ï¼š
å‚è€ƒä¿¡å· (t=0)    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å›å£°ä¿¡å· (t=40)   â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
                  âœ… å®Œç¾åŒ¹é…ï¼
```

---

## ğŸ¯ å…³é”®æ”¹è¿›ç‚¹æ€»ç»“

### 1. æµå»¶è¿Ÿä¿®æ­£ï¼ˆâ­â­â­â­â­ï¼‰

**é—®é¢˜**ï¼šè®¾ç½®ä¸º 0msï¼Œå‡è®¾å®Œå…¨åŒæ­¥
**è§£å†³**ï¼šè®¾ç½®ä¸º 40msï¼ŒåŒ¹é…å®é™…å»¶è¿Ÿ
**æ•ˆæœ**ï¼šAEC å¯ä»¥æ­£ç¡®å¯¹é½å’Œæ¶ˆé™¤å›å£°

### 2. å¸§å¤§å°ä¼˜åŒ–ï¼ˆâ­â­â­â­ï¼‰

**é—®é¢˜**ï¼š100ms å¸§ï¼Œå»¶è¿Ÿé«˜ï¼Œä¸ç¬¦åˆæ ‡å‡†
**è§£å†³**ï¼š10ms å¸§ï¼Œç¬¦åˆ WebRTC æ ‡å‡†
**æ•ˆæœ**ï¼šå»¶è¿Ÿé™ä½ 90%ï¼Œå®æ—¶æ€§æå‡

### 3. å™ªå£°æŠ‘åˆ¶å¹³è¡¡ï¼ˆâ­â­â­ï¼‰

**é—®é¢˜**ï¼šHIGH çº§åˆ«å¯èƒ½è¿‡åº¦æŠ‘åˆ¶è¯­éŸ³
**è§£å†³**ï¼šMODERATE çº§åˆ«ï¼Œå¹³è¡¡å™ªå£°å’Œè¯­éŸ³
**æ•ˆæœ**ï¼šè¯­éŸ³æ›´è‡ªç„¶ï¼Œå™ªå£°ä»å¯æ§

### 4. é…ç½®ç®€åŒ–ï¼ˆâ­â­ï¼‰

**é—®é¢˜**ï¼šæœªé…ç½®æˆ–é…ç½®å†²çª
**è§£å†³**ï¼šç¦ç”¨ä¸å¿…è¦çš„å¤„ç†ï¼Œå¯ç”¨å¿…è¦çš„å¢ç›Šæ§åˆ¶
**æ•ˆæœ**ï¼šç¨³å®šæ€§æå‡ï¼ŒCPU å ç”¨é™ä½

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### ä¿®æ”¹çš„æ–‡ä»¶

1. `src/asr/aec_processor.py` - AEC å¤„ç†å™¨ä¼˜åŒ–
2. `src/asr/audio_input.py` - éŸ³é¢‘è¾“å…¥ä¼˜åŒ–
3. `voice_to_voice.py` - ä¸»ç¨‹åºé…ç½®æ›´æ–°
4. `README.md` - æ·»åŠ  AEC è®¾ç½®æŒ‡å—é“¾æ¥

### æ–°å¢çš„æ–‡ä»¶

1. `AEC_SETUP_GUIDE.md` - è¯¦ç»†çš„ AEC è®¾ç½®æŒ‡å—
2. `AEC_OPTIMIZATION_SUMMARY.md` - ä¼˜åŒ–æ€»ç»“
3. `AEC_CHANGES.md` - æœ¬æ–‡æ¡£ï¼ˆä¿®æ”¹å¯¹æ¯”ï¼‰

---

## ğŸš€ ä½¿ç”¨æ–¹å¼

### æ–¹æ¡ˆ 1ï¼šç¡¬ä»¶ AECï¼ˆæ¨èï¼‰

```bash
# 1. åˆ›å»ºèšåˆè®¾å¤‡ï¼ˆå‚è€ƒ AEC_SETUP_GUIDE.mdï¼‰
# 2. æŸ¥æ‰¾è®¾å¤‡ç´¢å¼•
python list_audio_devices.py

# 3. å¯åŠ¨ç¨‹åº
python voice_to_voice.py --use-aggregate --device-index <ç´¢å¼•>
```

### æ–¹æ¡ˆ 2ï¼šè½¯ä»¶ AECï¼ˆå·²ä¼˜åŒ–ï¼‰

```bash
python voice_to_voice.py
```

### æ–¹æ¡ˆ 3ï¼šç¦ç”¨ AEC + è€³æœºï¼ˆæœ€ç¨³å®šï¼‰

```bash
python voice_to_voice.py --no-aec
```

---

## ğŸ” éªŒè¯æ–¹æ³•

### æ£€æŸ¥é…ç½®æ˜¯å¦ç”Ÿæ•ˆ

å¯åŠ¨ç¨‹åºåï¼ŒæŸ¥çœ‹è¾“å‡ºï¼š

```
âœ… WebRTC AEC åˆå§‹åŒ–å®Œæˆï¼ˆä¼˜åŒ–é…ç½®ï¼‰
   - å›å£°æ¶ˆé™¤: å·²å¯ç”¨ï¼ˆæ ‡å‡†æ¨¡å¼ï¼‰
   - å™ªå£°æŠ‘åˆ¶: MODERATEï¼ˆä¸­ç­‰ï¼‰
   - é«˜é€šæ»¤æ³¢: å·²å¯ç”¨
   - æµå»¶è¿Ÿ: 40msï¼ˆä¼˜åŒ–ï¼‰  â† ç¡®è®¤è¿™é‡Œæ˜¯ 40ms
   - å¢ç›Šæ§åˆ¶: è‡ªé€‚åº”æ•°å­—
```

### æµ‹è¯• AEC æ•ˆæœ

1. å¯åŠ¨ç¨‹åºï¼ˆä½¿ç”¨ç¡¬ä»¶ AECï¼‰
2. æ’­æ”¾éŸ³ä¹æˆ–è®© AI è¯´è¯
3. å¯¹ç€éº¦å…‹é£è¯´è¯
4. è§‚å¯Ÿæ˜¯å¦æœ‰å›å£°

**é¢„æœŸç»“æœ**ï¼š
- âœ… å›å£°æ˜æ˜¾å‡å°‘
- âœ… è¯­éŸ³æ¸…æ™°è‡ªç„¶
- âœ… å»¶è¿Ÿä½ï¼ˆ<50msï¼‰

---

## ğŸ’¡ æ•…éšœæ’é™¤

### é—®é¢˜ï¼šAEC æ•ˆæœä¸æ˜æ˜¾

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… ç¡®è®¤æµå»¶è¿Ÿä¸º 40msï¼ˆä¸æ˜¯ 0msï¼‰
2. âœ… ç¡®è®¤å¸§å¤§å°ä¸º 160ï¼ˆä¸æ˜¯ 1600ï¼‰
3. âœ… ç¡®è®¤ä½¿ç”¨èšåˆè®¾å¤‡ï¼ˆç¡¬ä»¶ AECï¼‰
4. âœ… ç¡®è®¤ BlackHole å·²å®‰è£…å¹¶é…ç½®

### é—®é¢˜ï¼šå£°éŸ³è¢«è¿‡åº¦æŠ‘åˆ¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# ä¿®æ”¹ src/asr/aec_processor.py:90
apm_config.noise_suppress.noise_level = 0  # LOWï¼ˆä½ï¼‰
```

### é—®é¢˜ï¼šå»¶è¿Ÿä»ç„¶å¾ˆé«˜

**æ£€æŸ¥**ï¼š
```python
# ç¡®è®¤ src/asr/audio_input.py:19
chunk_size: int = 160  # åº”è¯¥æ˜¯ 160ï¼Œä¸æ˜¯ 1600
```

---

## ğŸ‰ æ€»ç»“

é€šè¿‡å‚è€ƒ py-xiaozhi é¡¹ç›®ï¼Œæˆ‘ä»¬å®Œæˆäº†ä»¥ä¸‹ä¼˜åŒ–ï¼š

âœ… **æµå»¶è¿Ÿ**ï¼š0ms â†’ 40msï¼ˆæœ€å…³é”®ï¼‰
âœ… **å¸§å¤§å°**ï¼š100ms â†’ 10msï¼ˆé™ä½å»¶è¿Ÿï¼‰
âœ… **å™ªå£°æŠ‘åˆ¶**ï¼šHIGH â†’ MODERATEï¼ˆå¹³è¡¡ï¼‰
âœ… **é…ç½®ä¼˜åŒ–**ï¼šç®€åŒ–å¹¶ä¼˜åŒ–æ‰€æœ‰å‚æ•°

**é¢„æœŸæ•ˆæœ**ï¼š
- AEC æ•ˆæœæå‡ 2-3 å€
- å»¶è¿Ÿé™ä½ 75%
- è¯­éŸ³è´¨é‡æ›´è‡ªç„¶
- ç¨³å®šæ€§æ˜¾è‘—æå‡

**æ¨èä½¿ç”¨**ï¼š
1. ç¡¬ä»¶ AECï¼ˆèšåˆè®¾å¤‡ï¼‰- æœ€ä½³æ•ˆæœ
2. è€³æœºæ¨¡å¼ - æœ€ç¨³å®š
3. è½¯ä»¶ AEC - å·²ä¼˜åŒ–ä½†ä»å®éªŒæ€§

---

è¯¦ç»†è®¾ç½®æŒ‡å—ï¼š[AEC_SETUP_GUIDE.md](AEC_SETUP_GUIDE.md)
ä¼˜åŒ–æ€»ç»“ï¼š[AEC_OPTIMIZATION_SUMMARY.md](AEC_OPTIMIZATION_SUMMARY.md)
