# LLM + TTS 语音助手 - 使用说明

## 项目简介

这是一个集成了大语言模型（LLM）和文本转语音（TTS）的实时语音助手系统。支持多种 LLM 和 TTS 服务，提供流畅的语音对话体验。

### 核心特性

- **多 LLM 支持**：兼容 OpenAI API 格式（DeepSeek、Qwen 等）
- **多 TTS 支持**：通义千问 TTS、火山引擎 Seed2、MiniMax
- **三种对话模式**：实时模式、流式模式、普通模式
- **智能 Prompt 系统**：专为语音对话优化
- **多角色支持**：默认助手、轻松助手、专业助手、陪伴助手
- **上下文管理**：自动管理用户信息、知识库、对话历史

## 快速开始

### 1. 环境准备

确保已安装 Python 3.8 或更高版本。

### 2. 安装依赖

```bash
pip install -r requirements.txt
```

**依赖说明：**
- `openai` - LLM 客户端
- `requests` - HTTP 请求
- `python-dotenv` - 环境变量管理
- `dashscope` - 通义千问 SDK
- `volcengine-python-sdk` - 火山引擎 SDK
- `pyaudio` - 音频播放（可选）
- `pydub`, `simpleaudio` - 音频处理

**注意：** 如果 PyAudio 安装失败，系统会自动使用 ffplay 播放器。

### 3. 配置 API 密钥

复制 `.env.example` 为 `.env`：

```bash
cp .env.example .env
```

编辑 `.env` 文件，填入你的 API 密钥：

```env
# LLM API (OpenAI 兼容)
OPENAI_API_KEY=your_api_key
OPENAI_BASE_URL=https://api.deepseek.com
OPENAI_MODEL=deepseek-chat

# 通义千问 TTS
QWEN3_TTS_API_KEY=your_qwen3_key

# 火山引擎 Seed2 TTS
VOLCENGINE_APP_ID=your_app_id
VOLCENGINE_ACCESS_TOKEN=your_token

# MiniMax TTS
MINIMAX_API_KEY=your_minimax_key
MINIMAX_GROUP_ID=your_group_id
```

### 4. 运行程序

```bash
python src/main.py
```

或明确指定交互模式：

```bash
python src/main.py interactive
```

## 使用指南

### 交互命令

启动程序后，可以使用以下命令：

| 命令 | 说明 |
|------|------|
| `/quit` | 退出程序 |
| `/mode` | 切换对话模式（realtime/streaming/normal） |
| `/provider` | 切换 TTS 提供商（qwen3/volcengine） |
| `/role <角色>` | 切换角色（default/casual/professional/companion） |
| `/clear` | 清空对话历史 |
| `/history` | 查看对话历史 |
| `/setname <名字>` | 设置用户名 |
| `/addknowledge <内容>` | 添加知识库 |
| `/info` | 查看当前配置 |

### 使用示例

```
你: /role casual
✓ 已切换到角色: 轻松助手
  风格: 轻松聊天
  特点: 活泼、幽默、随和

你: /setname 小明
✓ 用户名已设置为: 小明

你: /addknowledge 喜欢攀岩
✓ 已添加知识: 喜欢攀岩

你: 推荐一些周末活动
助手: 小明你好！既然你喜欢攀岩，周末可以去攀岩馆练练手...

你: /info
当前配置:
  模式: 实时模式 (LLM逐字→TTS→边播边放) ⚡
  角色: 轻松助手 (活泼、幽默、随和)
  TTS 提供商: 通义千问 TTS
  对话轮数: 1
  知识库条目: 1
```

## 三种对话模式

### 1. 实时模式（Realtime）⚡

**最快，延迟最低**

- LLM 逐字输出
- TTS 实时接收并合成
- 音频边接收边播放

**支持的 TTS：** 通义千问、火山引擎

**适用场景：** 需要最低延迟的实时对话

### 2. 流式模式（Streaming）

**较快，按句播放**

- LLM 流式输出
- 按句子分割
- 每句合成后立即播放

**支持的 TTS：** 所有 TTS 提供商

**适用场景：** 平衡速度和稳定性

### 3. 普通模式（Normal）

**最稳定，等待完整回复**

- 等待 LLM 完整回复
- 一次性合成
- 播放完整音频

**支持的 TTS：** 所有 TTS 提供商

**适用场景：** 网络不稳定或需要完整回复

## 角色系统

### 可用角色

1. **默认助手（default）**
   - 特点：友好、专业、简洁
   - 适用：通用场景

2. **轻松助手（casual）**
   - 特点：活泼、幽默、随和
   - 适用：日常聊天

3. **专业助手（professional）**
   - 特点：严谨、专业、高效
   - 适用：工作场景

4. **陪伴助手（companion）**
   - 特点：温暖、关心、耐心
   - 适用：情感支持

### 自定义角色

可以在 `roles/` 目录下创建自定义角色文件：

```python
# roles/my_role.py
ROLE_CONFIG = {
    "id": "my_role",
    "name": "我的角色",
    "personality": "特点描述",
    "style": "风格描述",
    "system_prompt": "系统提示词...",
    "example_responses": [
        "示例回复1",
        "示例回复2"
    ]
}
```

## TTS 配置

### 通义千问 TTS（推荐）

**优点：**
- 支持实时模式
- 音质优秀
- 延迟低

**配置：**
```env
QWEN3_TTS_API_KEY=your_key
```

**支持音色：**
- Cherry（女声，默认）
- Stella（女声）
- Bella（女声）
- Cindy（女声）

### 火山引擎 Seed2

**优点：**
- 音质自然
- 支持实时模式
- 音色丰富

**配置：**
```env
VOLCENGINE_APP_ID=your_app_id
VOLCENGINE_ACCESS_TOKEN=your_token
```

### MiniMax

**优点：**
- 音质稳定
- 支持多种音色

**配置：**
```env
MINIMAX_API_KEY=your_key
MINIMAX_GROUP_ID=your_group_id
```

## 项目结构

```
llm-tts-api-test/
├── config/                      # 配置文件
│   ├── api_keys.json           # API 密钥（不提交到 git）
│   └── test_config.json        # 测试配置
├── data/                        # 数据目录
│   └── audios/                 # 生成的音频文件
├── roles/                       # 角色配置
│   ├── default.py              # 默认助手
│   ├── casual.py               # 轻松助手
│   ├── professional.py         # 专业助手
│   ├── companion.py            # 陪伴助手
│   └── README.md               # 角色说明
├── src/                         # 源代码
│   ├── audio/                  # 音频播放模块
│   │   ├── player.py           # 基础播放器
│   │   ├── streaming_player.py # 流式播放器（ffplay）
│   │   └── pyaudio_player.py   # 流式播放器（PyAudio）
│   ├── llm/                    # LLM 模块
│   │   └── llm_client.py       # LLM 客户端
│   ├── tts/                    # TTS 模块
│   │   ├── qwen3_tts.py        # 通义千问 TTS
│   │   ├── qwen3_realtime_tts.py # 通义千问实时 TTS
│   │   ├── volcengine_tts.py   # 火山引擎 TTS
│   │   ├── volcengine_realtime_tts.py # 火山引擎实时 TTS
│   │   └── minimax_tts.py      # MiniMax TTS
│   ├── config_loader.py        # 配置加载器
│   ├── role_loader.py          # 角色加载器
│   ├── streaming_pipeline.py   # 流式处理管道
│   ├── realtime_pipeline.py    # 实时处理管道
│   ├── text_cleaner.py         # 文本清理工具
│   ├── voice_assistant_prompt.py # Prompt 管理系统
│   └── main.py                 # 主程序
├── .env.example                # 环境变量示例
├── .gitignore                  # Git 忽略文件
├── requirements.txt            # Python 依赖
├── README.md                   # 英文说明
├── 使用说明.md                  # 中文说明（本文件）
└── VOICE_ASSISTANT_PROMPT.md   # Prompt 系统详细文档
```

## 常见问题

### 1. PyAudio 安装失败

PyAudio 是可选依赖，安装失败不影响使用，系统会自动使用 ffplay。

**macOS 安装：**
```bash
brew install portaudio
pip install pyaudio
```

**Ubuntu/Debian 安装：**
```bash
sudo apt-get install portaudio19-dev
pip install pyaudio
```

### 2. 音频播放失败

确保系统安装了 ffmpeg：

**macOS：**
```bash
brew install ffmpeg
```

**Ubuntu/Debian：**
```bash
sudo apt-get install ffmpeg
```

### 3. LLM 输出包含 Markdown 格式

虽然 Prompt 已经优化，但某些模型仍可能输出 Markdown。建议：

1. 降低 temperature 参数（0.7 左右）
2. 使用 `text_cleaner.py` 进行后处理
3. 尝试不同的模型

### 4. 实时模式延迟高

实时模式需要：

1. 稳定的网络连接
2. 低延迟的 LLM API
3. 支持流式的 TTS API

如果延迟高，建议切换到流式模式或普通模式。

### 5. API 密钥配置错误

检查 `.env` 文件：

1. 确保文件名为 `.env`（不是 `.env.txt`）
2. 确保没有多余的空格或引号
3. 确保 API 密钥有效且有足够额度

### 6. 找不到配置文件

确保 `config/api_keys.json` 文件存在。如果不存在，程序会自动从 `.env` 文件加载配置。

## 技术架构

### 实时流式处理流程

```
用户输入
  ↓
LLM 流式生成（逐字输出）
  ↓
实时 TTS（逐字接收，流式合成）
  ↓
流式音频播放（边接收边播放）
  ↓
用户听到语音
```

### 关键技术

1. **流式处理**：使用 Python 生成器实现零延迟传递
2. **实时 TTS**：支持流式输入和输出
3. **流式播放**：PyAudio 或 ffplay 实现边接收边播放
4. **Prompt 优化**：专为语音场景设计，控制输出格式

## 开发计划

- [ ] 支持更多 TTS 提供商
- [ ] 添加语音输入（STT）
- [ ] 支持多语言
- [ ] Web UI 界面
- [ ] 语音克隆功能
- [ ] 情感识别
- [ ] 打断功能

## 许可证

MIT License

## 贡献

欢迎提交 Issue 和 Pull Request！

## 联系方式

如有问题，请提交 Issue。
