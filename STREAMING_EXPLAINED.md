# 🔍 流式处理技术详解

## 📊 当前实现的信息传递流程

### 完整流程图

```
┌─────────────────────────────────────────────────────────────┐
│ 第 1 步：LLM 流式输出（OpenAI 兼容接口）                      │
├─────────────────────────────────────────────────────────────┤
│ Qwen-Plus 模型逐字生成：                                     │
│ "你" → "好" → "，" → "我" → "是" → "通" → "义" → "千" → "问" → "。" │
│                                                             │
│ 延迟：~50-100ms/字                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第 2 步：智能断句（BufferedSentenceSplitter）                │
├─────────────────────────────────────────────────────────────┤
│ 累积字符，检测断句点：                                        │
│                                                             │
│ 缓冲区: "你好，"                                             │
│   ↓ 检测到逗号 + 长度 >= 5                                   │
│ 输出: "你好，"                                               │
│                                                             │
│ 缓冲区: "我是通义千问。"                                      │
│   ↓ 检测到句号                                              │
│ 输出: "我是通义千问。"                                        │
│                                                             │
│ 断句规则：                                                   │
│ - 强结束符：。！？\n (立即分割)                               │
│ - 中等停顿：，, (长度 >= 5 时分割)                           │
│ - 弱结束符：.!? (长度 >= 10 时分割)                          │
│ - 最小长度：5 字符                                           │
│ - 最大长度：50 字符                                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第 3 步：TTS 合成（Qwen3 TTS Flash）                         │
├─────────────────────────────────────────────────────────────┤
│ 输入：完整句子 "你好，"                                       │
│                                                             │
│ Qwen3 TTS 处理：                                            │
│ 1. 分析文本语义                                              │
│ 2. 生成韵律信息                                              │
│ 3. 流式输出音频块：                                          │
│    Chunk 1: [20KB 音频数据]                                 │
│    Chunk 2: [20KB 音频数据]                                 │
│    Chunk 3: [10KB 音频数据]                                 │
│    Final:   [完整音频 URL]                                  │
│                                                             │
│ 延迟：~1-2 秒                                                │
│                                                             │
│ ⚠️ 限制：必须提供完整文本，不支持流式文本输入                  │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第 4 步：音频文件写入                                         │
├─────────────────────────────────────────────────────────────┤
│ 边接收边写入：                                               │
│ stream_20260110_182758_001.wav                              │
│                                                             │
│ 文件大小：~50-100KB (取决于文本长度)                          │
└─────────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────────┐
│ 第 5 步：音频播放（afplay on macOS）                         │
├─────────────────────────────────────────────────────────────┤
│ 阻塞播放：等待播放完成                                        │
│ 播放时长：~1-2 秒                                            │
└─────────────────────────────────────────────────────────────┘
```

### 三线程并行架构

```
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  线程 1      │    │  线程 2      │    │  线程 3      │
│  文本生产者   │───▶│  TTS 处理器  │───▶│  音频播放器   │
└──────────────┘    └──────────────┘    └──────────────┘
       │                   │                   │
       ▼                   ▼                   ▼
  [文本队列]          [音频队列]          [播放队列]

  Queue<String>       Queue<AudioPath>    Sequential Play
```

## ⏱️ 时间线分析

### 示例：回复 "你好，我是通义千问。"

```
时间轴 (秒)
0.0  ┃ 用户输入问题
     ┃
0.1  ┃ LLM 开始生成
     ┃ ▓ "你"
0.2  ┃ ▓ "好"
0.3  ┃ ▓ "，"  ← 检测到逗号，长度 = 3 (< 5，继续累积)
0.4  ┃ ▓ "我"
0.5  ┃ ▓ "是"  ← 长度 = 5，可以分割了
     ┃ ✓ 句子 1: "你好，我是" → 送入 TTS
     ┃
1.5  ┃ TTS 合成中...
     ┃
2.5  ┃ ✓ 音频 1 生成完成
     ┃ ▶ 开始播放 "你好，我是"
     ┃
3.0  ┃ LLM 继续生成
     ┃ ▓ "通" "义" "千" "问" "。"
     ┃ ✓ 句子 2: "通义千问。" → 送入 TTS
     ┃
4.0  ┃ ▶ 播放完 "你好，我是"
     ┃ TTS 合成句子 2...
     ┃
5.0  ┃ ✓ 音频 2 生成完成
     ┃ ▶ 开始播放 "通义千问。"
     ┃
6.0  ┃ ▶ 播放完成
     ┃ ✓ 全部完成
```

**总延迟**：
- 首句播放：2.5 秒
- 总时长：6 秒

## 🚫 为什么不能更流畅？

### TTS 的根本限制

```
❌ 不可行：逐字输入
─────────────────────
LLM: "你" → TTS: ??? (不知道后面是什么，无法确定语调)
LLM: "好" → TTS: ??? (还是不知道)
LLM: "，" → TTS: ??? (是逗号停顿还是句末？)

✅ 必须：完整句子
─────────────────────
LLM: "你好，" → TTS: 知道是逗号停顿，生成正确语调
LLM: "你好！" → TTS: 知道是感叹，生成上扬语调
LLM: "你好？" → TTS: 知道是疑问，生成疑问语调
```

### Qwen3 TTS 的限制

根据官方文档：
- ❌ **流式输入**：不支持
- ✅ **流式输出**：支持（音频数据流式返回）

这意味着：
```
输入端：必须等待完整文本
输出端：可以边生成边输出音频块
```

## 💡 当前优化策略

### 1. 更短的分割单位

**之前**：
```
"你好，我是通义千问，很高兴认识你。"
→ 一整句 (延迟 3-4 秒)
```

**现在**：
```
"你好，" → 播放 (延迟 1.5 秒)
"我是通义千问，" → 播放 (延迟 1.5 秒)
"很高兴认识你。" → 播放 (延迟 1.5 秒)
```

### 2. 并行处理

```
时间 0s:  LLM 生成句子 1
时间 1s:  LLM 生成句子 2 | TTS 合成句子 1
时间 2s:  LLM 生成句子 3 | TTS 合成句子 2 | 播放句子 1
时间 3s:  LLM 完成      | TTS 合成句子 3 | 播放句子 2
时间 4s:                |                | 播放句子 3
```

### 3. 智能断句

```python
# 断句优先级
1. 句号、问号、感叹号 (。！？)  → 立即分割
2. 逗号 (，,)                  → 长度 >= 5 时分割
3. 分号、顿号 (；;、)          → 长度 >= 5 时分割
4. 英文句号 (.!?)              → 长度 >= 10 时分割
5. 超长强制分割                → 长度 > 50 时分割
```

## 🎯 实际效果

### 非流式模式
```
用户: 请介绍一下你自己
      ↓
等待 15 秒...
      ↓
播放完整回复 (30 秒)
```

### 流式模式（当前）
```
用户: 请介绍一下你自己
      ↓
等待 2 秒...
      ↓
播放第 1 句 (3 秒)
播放第 2 句 (3 秒)
播放第 3 句 (3 秒)
...
```

**改进**：
- 首句延迟：15秒 → 2秒 (降低 87%)
- 用户体验：等待 → 实时响应

## 🔮 未来可能的改进

### 方案 A: 使用支持流式输入的 TTS

某些 TTS 服务（如 ElevenLabs）支持：
```python
stream = tts.start_stream()
for chunk in llm_output:
    stream.add_text(chunk)  # 逐字输入
    audio = stream.get_audio()  # 实时获取音频
    play(audio)
```

### 方案 B: 预测性断句

使用 AI 预测句子边界：
```python
buffer = "你好，我"
if ai_predict_sentence_end(buffer):  # AI 预测这可能是完整语义
    tts.synthesize(buffer)
```

### 方案 C: 本地 TTS 模型

使用本地模型（如 Coqui TTS）：
- 延迟更低
- 可以自定义流式逻辑
- 但质量可能不如云端

## 📝 总结

**当前实现已经是在 Qwen3 TTS 限制下的最优方案**：

✅ **已实现**：
- LLM 流式输出
- 智能断句（逗号分割）
- TTS 流式音频输出
- 三线程并行处理
- 首句延迟降低 87%

❌ **无法实现**（受 TTS 限制）：
- 逐字输入 TTS
- 完全无缝的语音流
- 零延迟播放

**这就是为什么你感觉"一句一句"的原因** - 因为 TTS 必须等待完整的句子才能正确合成语调和韵律。

要实现更流畅的效果，需要：
1. 使用支持流式文本输入的 TTS 服务
2. 或者使用本地 TTS 模型
3. 或者接受当前的"分句播放"模式
